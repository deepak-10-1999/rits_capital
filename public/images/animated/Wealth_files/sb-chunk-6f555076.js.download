(window.msfast_searchux_sb_jsonp=window.msfast_searchux_sb_jsonp||[]).push([["events-logger"],{"sU/U":function(t,e,n){"use strict";n.r(e),n.d(e,"default",(function(){return j}));var r=n("+zb2"),o=n("Bu7D"),i=n("KUM7"),a=n("Ee7w"),s=n("ozfy");function c(t,e,n,o,i,c){void 0===n&&(n=t);var h,l,d,f,v,g=!1,b=!1;function p(t){return t.then((function(t){return _(),t}),(function(t){throw _(),t}))}function _(){if(i&&h){var t=l||u(h,!1,"soft timeout; retry succeeded");i(t,f,v)}}function y(){return Object(r.__awaiter)(this,void 0,void 0,(function(){var e,a,s;return Object(r.__generator)(this,(function(r){switch(r.label){case 0:h={startTime:new Date},r.label=1;case 1:return r.trys.push([1,3,,8]),[4,t()];case 2:return a=r.sent(),g=!0,i&&(l=u(h,!0)),[2,a];case 3:if(e=r.sent(),i&&(l=u(h,!1,e)),c||o&&e&&o(e))return b=!0,[2,Promise.reject(e)];if(b)return[2,Promise.reject("Another retry has already been attempted.")];b=!0,d={startTime:new Date,isDelayedRetry:!1},r.label=4;case 4:return r.trys.push([4,6,,7]),[4,n()];case 5:return a=r.sent(),v=!g,g=!0,i&&(f=u(d,!0)),[2,a];case 6:return s=r.sent(),i&&(f=u(d,!1,s)),[2,Promise.reject(s)];case 7:return[3,8];case 8:return[2]}}))}))}if(!e)return p(y());var T,m=new Promise((function(t,r){function o(){if(g||b)return clearInterval(a),clearTimeout(s),r()}var a=setInterval(o,20);o();var s=setTimeout((function(){if(clearInterval(a),g||b)return r();b=!0,d={startTime:new Date,isDelayedRetry:!0},n().then((function(e){i&&d&&(v=!g,f=u(d,!0)),t(e)}),(function(t){i&&d&&(f=u(d,!1,t)),r(t)}))}),e)}));return p((T=[y(),m],new Promise((function(t,e){var n,r=0,o=Object(a.a)(T);0===o&&t(),Object(s.a)(T,(function(i){i.then((function(e){return t(e)}),(function(t){if(r++,null!=t&&(n=t),r>=o)return e(n)}))}))}))))}function u(t,e,n){return Object(r.__assign)(Object(r.__assign)({},t),{durationInMs:(new Date).getTime()-t.startTime.getTime(),succeeded:e,error:n})}var h=n("4Nfb"),l=n("GFGo"),d=n("L1IH"),f=n("/oRm"),v=n("W4Bk"),g=n("BsjR"),b=n("28CS"),p=n("iVFh"),_=function(){function t(t,e,n){this.getAccessTokenAsync=t,this.getAccessToken=e,this.getRawAccessToken=n}return t.prototype.getToken=function(){if(this.getRawAccessToken)return this.getRawAccessToken();if(this.substrateToken&&this.hasValidToken())return this.substrateToken.token;if(this.getAccessToken){var t=this.getAccessToken();if(t)return this.setToken(t),t.token}},t.prototype.getTokenAsync=function(){return Object(r.__awaiter)(this,void 0,void 0,(function(){var t;return Object(r.__generator)(this,(function(e){switch(e.label){case 0:if(this.substrateToken&&this.hasValidToken())return[2,this.substrateToken.token];if(!this.getAccessTokenAsync)throw Error("SubstrateTokenProvider: getAccessTokenAsync is undefined");return[4,this.getAccessTokenAsync()];case 1:return t=e.sent(),this.setToken(t),[2,t.token]}}))}))},t.prototype.setToken=function(t){this.substrateToken=t},t.prototype.hasValidToken=function(){return!(!this.substrateToken||!this.substrateToken.tokenExpiry)&&this.substrateToken.tokenExpiry>(new Date).getTime()},t}(),y=function(){function t(t,e,n,r,o,i,a,s,c){void 0===a&&(a=1e3),void 0===c&&(c="3sEventsAPI"),this._defaultScenarioName=t,this._localStorageKey=e,this._getAuthTokenAsync=n,this._getAuthToken=r,this._getRawAuthToken=o,this.isTokenValidationEnabled=i,this._batchTimeout=a,this.onError=s,this.apiName=c,this._batch={},this._retriesRemaining=4,this._logBatchAfterTimeout=0,this._timerIsRunning=!1,this._localStorageAvailable=!1,this.isTokenValidationEnabled&&(this._substrateTokenProvider=new _(this._getAuthTokenAsync,this._getAuthToken,this._getRawAuthToken)),this._localStorageAvailable="undefined"!=typeof localStorage&&!!localStorage,this.getBatchFromLocalStorage()}return t.prototype.logEvent=function(t,e,n,r){this.addEvent(r||this._defaultScenarioName,e,this.formatEvent(t),n),this._timerIsRunning||(this.resetRetryCounter(),this.startTimer())},t.prototype.flush=function(){return Object(r.__awaiter)(this,void 0,void 0,(function(){return Object(r.__generator)(this,(function(t){switch(t.label){case 0:return clearTimeout(this._logBatchAfterTimeout),[4,this.logBatch()];case 1:return t.sent(),[2]}}))}))},t.prototype.dispose=function(){clearTimeout(this._logBatchAfterTimeout),this.batchFlush()},t.prototype.getBatch=function(){return this._batch},t.prototype.testMergeBack=function(){var t=this,e=this.getBatchToSend();Object(s.a)(e,(function(e){t.mergeBack(e.scenario,e.ebatch)}))},t.prototype.increaseBatchTimeout=function(){this._batchTimeout<3500&&(this._batchTimeout+=1e3)},t.prototype.logError=function(t,e,n,r){var o;void 0===t&&(t="An error occurred");var i="".concat(this.apiName,": ").concat(t+("string"==typeof e?", Error Message: ".concat(e):""));Object(h.d)((function(){return i}),e),null===(o=this.onError)||void 0===o||o.call(this,i,n,r)},t.prototype.mergeBack=function(t,e,n){void 0===n&&(n=!0),!this._batch[t]||Object(g.a)(this._batch[t])?this._batch[t]=e:this._batch[t]=Object(b.a)(this._batch[t],e),!this._timerIsRunning&&this._retriesRemaining>0&&n&&(this.decrementRetryCounter(),this.startTimer())},t.prototype.batchFlush=function(){var t,e,n=this;if(!Object(g.a)(this._batch)){var o,i,a;if(this.getBatchFromLocalStorage(!1),this.isTokenValidationEnabled&&this._substrateTokenProvider)(a=null===(t=this._substrateTokenProvider)||void 0===t?void 0:t.getToken())||""===a?o=a:i=null===(e=this._substrateTokenProvider)||void 0===e?void 0:e.getTokenAsync;else(a=this.getToken(!0))?o=a:i=function(){return Object(r.__awaiter)(n,void 0,void 0,(function(){var t,e=this;return Object(r.__generator)(this,(function(n){switch(n.label){case 0:return[4,this.refreshToken().catch((function(t){e.logError("".concat(e.apiName,": failed to get async token"),t)}))];case 1:return[2,null===(t=n.sent())||void 0===t?void 0:t.token]}}))}))};if(!o&&""!==o)return Object(h.b)((function(){return"".concat(n.apiName,": no auth token. Aborting events API call")})),void(null==i||i().then((function(t){t&&n.batchFlushInner(t)})));this.batchFlushInner(o)}},t.prototype.batchFlushInner=function(t){var e=this,n=this.getBatchToSend();Object(s.a)(n,(function(n){e.sendLogBatch(n,{token:t})}))},t.prototype.formatEvent=function(t){return{Name:t.Name,Attributes:Object(d.a)(Object(p.a)(t.Attributes,(function(t,e){return!t&&0!==t||!e})),(function(t,e){return{Key:e,Value:null==t?void 0:t.toString()}}))}},t.prototype.logBatch=function(){var t,e;return Object(r.__awaiter)(this,void 0,void 0,(function(){var n,o,i,a,c=this;return Object(r.__generator)(this,(function(r){switch(r.label){case 0:return this._timerIsRunning=!1,Object(g.a)(this._batch)?[2]:this.isTokenValidationEnabled&&this._substrateTokenProvider?(o=null===(t=this._substrateTokenProvider)||void 0===t?void 0:t.getToken())||""===o?(n=o,[3,3]):[3,1]:[3,4];case 1:return[4,null===(e=this._substrateTokenProvider)||void 0===e?void 0:e.getTokenAsync().catch((function(t){c.logError("failed to get async token",t)}))];case 2:n=r.sent(),r.label=3;case 3:return[3,7];case 4:return(o=this.getToken())?(n=o,[3,7]):[3,5];case 5:return[4,this.refreshToken()];case 6:r.sent(),this._authToken&&(n=this._authToken.token),r.label=7;case 7:return n||""===n?(i=this.getBatchToSend(),a=n,Object(s.a)(i,(function(t){c.sendLogBatchAsync(t,{token:a,isRetry:c._retriesRemaining<4})})),[2]):(this.logError("no auth token. Aborting events API call"),[2])}}))}))},t.prototype.addEvent=function(t,e,n,r){void 0===r&&(r=Object(v.a)()),this._batch[t]||(this._batch[t]={}),this._batch[t][e]||(this._batch[t][e]={}),this._batch[t][e][r]=n},t.prototype.resetRetryCounter=function(){this._retriesRemaining=4},t.prototype.decrementRetryCounter=function(){this._retriesRemaining--},t.prototype.startTimer=function(){var t=this;this._timerIsRunning=!0,this._logBatchAfterTimeout=setTimeout((function(){return t.logBatch()}),this._batchTimeout)},t.prototype.getBatchFromLocalStorage=function(t){var e=this;if(void 0===t&&(t=!0),this._localStorageAvailable){var n=localStorage.getItem(this._localStorageKey);if(n&&n.length>0){var r=JSON.parse(n);3===r.LocalStorageVersion&&Object(s.a)(r.Batch,(function(n,r){e.mergeBack(r,n,t)}))}var o="";t||(o=JSON.stringify(this.getBatchToSave())),localStorage.setItem(this._localStorageKey,o)}},t.prototype.getBatchToSave=function(){var t=this;return Object.keys(this._batch).forEach((function(e){var n=Object.keys(t._batch[e]);if(n.length>40)for(var r=n.length-40,o=0;o<r;o++)delete t._batch[e][n[o]]})),{LocalStorageVersion:3,Batch:this._batch}},t.prototype.getBatchToSend=function(){var t=this,e=this._batch;return this._batch={},Object(d.a)(e,(function(e,n){return{scenario:n,ebatch:e,body:t.getBodyFromEventsBatch(e,n)}}))},t.prototype.getToken=function(t){if(this._authToken&&this._authToken.tokenExpiry)return t&&0===this._authToken.tokenExpiry||this._authToken.tokenExpiry>(new Date).getTime()?this._authToken.token:void 0},t.prototype.refreshToken=function(){return Object(r.__awaiter)(this,void 0,void 0,(function(){var t,e=this;return Object(r.__generator)(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),this._authToken=void 0,[4,this._getAuthTokenAsync().then((function(t){return e._authToken=t,t}))];case 1:return[2,n.sent()];case 2:return t=n.sent(),this.logError("failure getting token",t),[2];case 3:return[2]}}))}))},t}(),T=function(t){function e(e,n,r,o,i,a,s,c,u,h,l,d,f,v){void 0===a&&(a=1e3);var g=t.call(this,e,"Search3sLoggingBeforeUnload",n,r,o,i,a,l)||this;return g._xAnchorMailbox=s,g.locale=c,g.substrateHostName=u,g.useNoBearerAuth=h,g.disableMonitorTypeRequest=d,g.useDefaultHostNameOnFailure=f,g.enableDiagMetadataOnError=v,g._substrateApiUrl="",g._substrateApiUrl=g.getEventsDestination(),g}return Object(r.__extends)(e,t),e.prototype.log3SEvent=function(t,e){this.logEvent(t,e,t.EventKey)},e.prototype.sendLogBatch=function(t,e){var n=this,r=e.token,o=this._substrateApiUrl.replace("{0}",t.scenario),i=this.getEventsPartitions(t).batches;Object(s.a)(i,(function(e){Object(l.a)(o,r,!1,n._xAnchorMailbox,n.locale,void 0,n.useNoBearerAuth).xhr.send(JSON.stringify(e)),Object(h.b)((function(){return"Event Logged to 3s Events API on Flush:\n"}),{scenario:t.scenario,batchToSend:t.ebatch,body:t.body},"\nTime: ",Math.floor(Date.now()))}))},e.prototype.sendLogBatchAsync=function(t,e){var n=this,r=e.token,o=e.isRetry,i=this.getEventsPartitions(t),a=i.batches,c=i.ebatches,u=o&&this.useDefaultHostNameOnFailure?this.getEventsDestination(!0):this._substrateApiUrl;u=u.replace("{0}",t.scenario);var h=!1;Object(s.a)(a,(function(e,o){return(n.disableMonitorTypeRequest?n.sendEventsWithoutMonitor(u,t,r,e):n.sendEventsWithMonitor(t,r,e)).catch((function(e){n.mergeBack(t.scenario,c[o]),!h&&(h=500===e.statusCode)}))})),h&&this.increaseBatchTimeout()},e.prototype.getBodyFromEventsBatch=function(t){return Object(d.a)(t,(function(t,e){return{Key:e,Value:Object(d.a)(t,(function(t){return t}))}}))},e.prototype.sendEventsWithMonitor=function(t,e,n){var r=this;return c((function(){var o;return Object(l.c)({action:"logevents",dataSource:"search-3s-logging",token:e,query:JSON.stringify(n),additionalInfo:(o={},o.scenario=t.scenario,o),anchorMailbox:r._xAnchorMailbox,locale:r.locale,logDiagnosticsMetrics:!1,substrateHostName:r.substrateHostName,useNoBearerAuth:r.useNoBearerAuth})})).then((function(e){Object(h.b)((function(){var t;return"3sEventsAPI: batch logged successfully with TraceId:\n"+(null===(t=e.parsedBody)||void 0===t?void 0:t.Instrumentation.TraceId)+"\n"}),{scenario:t.scenario,batchToSend:t.ebatch,body:t.body},"\nTime: ",Math.floor(Date.now()))})).catch((function(t){var e,n,o,i;throw r.logError("call failure with TraceId: ".concat((null===(n=null===(e=t.parsedBody)||void 0===e?void 0:e.Instrumentation)||void 0===n?void 0:n.TraceId)||"",", Status: ").concat(t.statusCode||""),null===(i=null===(o=t.parsedBody)||void 0===o?void 0:o.error)||void 0===i?void 0:i.message,t.statusCode),t}))},e.prototype.sendEventsWithoutMonitor=function(t,e,n,r){var o=this;return c((function(){return Object(l.d)({url:t,token:n,body:JSON.stringify(r),anchorMailbox:o._xAnchorMailbox,locale:o.locale,substrateSearchClientFlights:void 0,useNoBearerAuth:o.useNoBearerAuth})})).then((function(t){var n,r=null===(n=null==t?void 0:t.Instrumentation)||void 0===n?void 0:n.TraceId;Object(h.b)((function(){return"3sEventsAPI: batch logged successfully with TraceId:\n"+r+"\n"}),{scenario:e.scenario,batchToSend:e.ebatch,body:e.body},"\nTime: ",Math.floor(Date.now()))})).catch((function(e){var n,i,a="",s=500,c=void 0,u=void 0;throw"string"==typeof e?c=e:(a=(null===(n=null==e?void 0:e.Instrumentation)||void 0===n?void 0:n.TraceId)||"",s=e.statusCode,c=null===(i=null==e?void 0:e.error)||void 0===i?void 0:i.message,u=e.metadata?o.createErrorMetadataDetails(e.metadata,t,r):void 0),o.logError("call failure with TraceId: ".concat(a,", Status: ").concat(s),c,s,u?JSON.stringify(u):void 0),e}))},e.prototype.getEventsPartitions=function(t){var e=t.body,n=Object(f.a)(e,10),r=[];return Object(s.a)(n,(function(e){var n={};Object(s.a)(e,(function(e){n[e.Key]=t.ebatch[e.Key]})),r.push(n)})),{batches:n,ebatches:r}},e.prototype.getEventsDestination=function(t){var e=this.substrateHostName&&!t?this.substrateHostName.toLocaleLowerCase().startsWith("http")?this.substrateHostName:"https://".concat(this.substrateHostName):"https://substrate.office.com";return"".concat(e).concat("/search/api/v1/events?scenario={0}")},e.prototype.createErrorMetadataDetails=function(t,e,n){var o=void 0;try{o=JSON.stringify(Object(r.__assign)({requestSize:this.getRequestSizeInBytes(t.body),url:e,body:t.body&&t.body.substring(0,1e4)},this.enableDiagMetadataOnError?{diagData:this.createDiagMetadataDetails(n)}:{}))}catch(t){t.message&&this.logError("Error in creating error metadata details",t.message)}return o},e.prototype.createDiagMetadataDetails=function(t){var e={};return Object(s.a)(t,(function(t){e[t.Key]=t.Value.length})),{eventsPerKey:e,numKeys:t.length}},e.prototype.getRequestSizeInBytes=function(t){return t?(new TextEncoder).encode(t).length:0},e}(y),m=function(){function t(t,e,n,r,o,i,a,s,c,u,h){this._scenarioName=t,this._eventMapper=e,this._getAuthTokenAsync=n,this._getAuthToken=r,this._getRawAuthToken=o,this.isTokenValidationEnabled=i,this._xAnchorMailbox=a,this._batchTimeout=s,this.locale=c,this.substrateHostName=u,this.useNoBearerAuth=h,this._logManager=new T(this._scenarioName,this._getAuthTokenAsync,this._getAuthToken,this._getRawAuthToken,this.isTokenValidationEnabled,this._batchTimeout,this._xAnchorMailbox,c,u,h)}return t.prototype.canConsumeEvent=function(t){return!0},t.prototype.consume=function(t,e){var n=this._eventMapper(t);if(n){var r=this.getKey(n);this._logManager&&r&&this._logManager.logEvent(n,r,e)}},t.prototype.flush=function(){return this._logManager&&this._logManager.flush(),Promise.resolve()},t.prototype.destroy=function(){this.flush(),delete this._logManager},t.prototype.getLogManager=function(){return this._logManager},t.prototype.getKey=function(t){var e,n,r;switch(t.Name){case"CachedContentRendered":return null===(e=null==t?void 0:t.Attributes.NewLogicalId)||void 0===e?void 0:e.toString();case"SearchEntityActions":case"SearchActions":case"ClientDataSource":case"ClientLayout":case"ResultsRendered":case"SearchFeedback":case"CounterFactualInformation":return null===(n=null==t?void 0:t.Attributes.LogicalId)||void 0===n?void 0:n.toString();case"ResponseReceived":return null===(r=null==t?void 0:t.Attributes.TraceId)||void 0===r?void 0:r.toString();default:Object(i.a)(t.Name)}},t}();n("32I/");const k=["search-3s-logging","SubstrateWarmup_RoundTripTime"];function S(t){if(!function(t){const e=t;switch(e){case"MicrosoftSearchClickEvent":case"MicrosoftSearchClickEntityEvent":case"MicrosoftSearchClientDataSourceEvent":case"MicrosoftSearchClientLayoutEvent":case"MicrosoftSearchRoundTripTimeEvent":case"MicrosoftSearchResultsRenderedEvent":case"MicrosoftSearchCachedContentRenderedEvent":case"MicrosoftSearchFeedbackEvent":case"MicrosoftSearchCounterFactualInformationEvent":return!0;case"MicrosoftSearchClientDataSourceAriaEvent":case"MicrosoftSearchClickAriaEvent":case"MicrosoftSearchDiagnosticsEvent":case"MicrosoftSearchPerformanceEvent":case"MicrosoftSearchValidateEvent":case"MicrosoftSearchRoundTripTimeBundleEvent":case"MicrosoftSearchQueryEvent":case"MicrosoftSearchRankingEvent":case"MicrosoftSearchImpressionEvent":case"MicrosoftSearchAnswerResultsRenderedEvent":case"MicrosoftSearchSignInEvent":case"MicrosoftSearchSignOutEvent":case"MicrosoftSearchValueEvent":case"MicrosoftSearchQfValueEvent":case"MicrosoftSearchQfRankEvent":case"MicrosoftSearchResourcePerformanceEvent":case"MicrosoftSearchPerformanceTimingsEvent":case"MicrosoftSearchVariantEvent":case"MicrosoftSearchQfVariantEvent":case"MicrosoftSearchPrivacyEvent":case"MicrosoftSearchLatencyEvent":case"MicrosoftSearchMissingInstEvent":return!1;default:return Object(i.b)(e,!1)}}(t.featureName))return;const{properties:e}=t,n=e;let r;switch(t.source){case"ResponseReceived":r=-1===k.indexOf(t.eventId)?t.source:void 0;break;default:r=t.source}return function(t,e,n,r){if(t)return n?{name:t,properties:r?Object.assign(Object.assign({},e),{metadata:JSON.stringify(r)}):e}:{Name:t,Attributes:r?Object.assign(Object.assign({},e),{Metadata:JSON.stringify(r)}):e}}(r,n,!1)}var E,A=n("2npF"),O=n("D72S");function M(t){var e=(t.getBufferedLogEvents&&t.getBufferedLogEvents()||t.logEventBuffer||[]).slice(),n=null;function i(){return Object(r.__awaiter)(this,void 0,void 0,(function(){var e;return Object(r.__generator)(this,(function(n){switch(n.label){case 0:return e={},[4,t.tokenProvider({attempt:0}).then((function(t){return t}))];case 1:return e.token=n.sent(),[2,e]}}))}))}var a=t.instrumenter;var s,c=(s=t.logCtx.hostAppInfo,new m(s.id,S,i,void 0,void 0,void 0,void 0,void 0,void 0,Object(O.a)(a)));function u(e){var n=e;return"ClientDataSource"==n.name&&(n=function(e){var n=t.logCtx,o=n.userInfo,i=n.tenantInfo;return{name:"ClientDataSource",eventType:"USAGE",nameDetail:e.nameDetail,properties:Object(r.__assign)(Object(r.__assign)({},e.properties),{UserId:o.id,TenantId:i.omsId})}}(n)),Object(r.__assign)(Object(r.__assign)({},n),{featureName:h(n.name),eventId:n.nameDetail,source:n.name})}function h(t){switch(t){case"ResponseReceived":return"MicrosoftSearchRoundTripTimeEvent";case"ClientLayout":return"MicrosoftSearchClientLayoutEvent";case"ResultsRendered":return"MicrosoftSearchResultsRenderedEvent";case"ClientDataSource":return"MicrosoftSearchClientDataSourceEvent";case"SearchFeedback":return"MicrosoftSearchFeedbackEvent";case"SearchActions":return"MicrosoftSearchClickEvent";case"SearchEntityActions":return"MicrosoftSearchClickEntityEvent";case"CachedContentRendered":return"MicrosoftSearchCachedContentRenderedEvent";case"CounterFactualInformation":return"MicrosoftSearchCounterFactualInformationEvent";default:return t}}function l(t){c&&function(t){return("QOSSTOP"==t.eventType||"USAGE"==t.eventType)&&Object(A.e)(t.name)}(t)&&c.consume(u(t))}return a&&Object(o.a)(a,["hostAppInfo"],(function(){c&&(c.destroy(),c=new m(a.props.hostAppInfo.id,S,i,void 0,void 0,void 0,void 0,void 0,void 0,Object(O.a)(a)))})),{enable:function(){e.forEach(l),e=[],null===n&&(n=t.dispatcher.register(l))},disable:function(){n&&(t.dispatcher.unregister(n),n=null)}}}function j(t){E||(E=M(Object(r.__assign)({},t))).enable()}}}]);